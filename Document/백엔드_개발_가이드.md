# RentalWeb 백엔드 개발 가이드

이 문서는 다른 컴퓨터에서 개발을 시작하거나, 새로운 팀원이 합류했을 때 필요한 세팅 및 개발 규칙을 안내합니다.

---

## 1. 초기 개발 환경 세팅 (New Machine)

### 필수 설치 도구
- **Node.js**: v18 이상 추천
- **Git**: 소스 코드 관리
- **PostgreSQL**: (직접 설치하거나 Supabase 사용 권장)

### 프로젝트 시작 순서
1.  **소스 코드 클론**
    ```bash
    git clone https://github.com/your-repo/RentalWeb.git
    cd Project/server
    ```
2.  **의존성 패키지 설치**
    ```bash
    npm install
    ```
3.  **환경 변수 설정**
    - `Project/server/.env.example` 파일을 복사하여 `.env` 파일을 생성합니다.
    - `DATABASE_URL`과 `JWT_SECRET`을 자신의 환경에 맞게 수정합니다.
    - **Supabase Storage**: `SUPABASE_URL`, `SUPABASE_KEY` 등을 입력하여 파일 업로드 기능을 활성화합니다.
    - **Solapi(CoolSMS)**: `SOLAPI_API_KEY`, `SOLAPI_API_SECRET` 등을 입력하여 실제 문자 발송 기능을 활성화합니다. 설정이 없으면 자동으로 Mock 모드로 동작합니다.

---

## 3. 주요 구현 로직

### 로그인 보안 (Login Security)
- **무차별 대입 방어**: 동일 계정으로 5회 연속 로그인 실패 시, 해당 계정은 10분간 잠금 처리됩니다. (`User` 테이블의 `login_attempts`, `lock_until` 컬럼 활용)
- 로그인 성공 시 실패 횟수는 즉시 초기화됩니다.

### 휴무일 처리 (Holiday Logic)
- 주말 및 DB에 등록된 휴무일에는 대여 시작/반납이 불가능하도록 서버에서 검증합니다.
- 플로터 수령 예정일 계산 시 주말/휴무일을 제외한 영업일(Business Day) 기준 2일 뒤를 자동으로 산출합니다.

### 재고 및 대여 관리 (Inventory & Rental)
- **실시간 재고 계산**: 물품 목록 조회 시, 현재 시간 기준으로 `RESERVED` 또는 `RENTED` 상태인 대여 건의 수량을 총 재고에서 차감하여 가용 수량(`currentStock`)을 실시간으로 계산하여 반환합니다.
- **예약 무결성**: 대여 예약 시 `Prisma Transaction`을 사용하여 재고 확인과 예약 생성을 원자적으로 처리함으로써 동시성 문제를 방지합니다.

### 파일 검증 (PDF Verification)
- 플로터 주문 시 업로드된 파일의 확장자뿐만 아니라 실제 파일 헤더(Magic Number: `%PDF-`)를 검사하여 유효한 PDF 파일인지 확인합니다.
- **참고:** 현재 파일 업로드 로직은 `PlotterService`를 통한 주문 신청 시에만 사용 가능하며, 관리자 물품 이미지 등록을 위한 공용 업로드 API는 추후 구현 예정입니다.

---

## 4. 테스트 및 검증 방법

### 단위 테스트 (Unit Test)
```bash
# 전체 테스트 실행
npm run test

# 특정 서비스 테스트 (예: SMS)
npm run test src/sms/sms.service.spec.ts
```

### 실제 서비스 연동 테스트 (Manual Test Scripts)
백엔드 서버를 켜지 않고도 SMS 발송이나 파일 업로드가 잘 되는지 터미널에서 바로 확인해 볼 수 있습니다.

**1. SMS 발송 테스트 (본인 번호로)**
```powershell
npx ts-node -e "require('dotenv').config(); const { SmsService } = require('./src/sms/sms.service'); const s = new SmsService(); s.sendVerificationCode('01012345678', '123456').then(r => console.log('결과:', r)).catch(e => console.error('에러:', e))"
```

**2. 파일 업로드 테스트 (Supabase)**
```powershell
npx ts-node -e "require('dotenv').config(); const { FilesService } = require('./src/common/files.service'); const fs = new FilesService(); const mockFile = { buffer: Buffer.from('Hello Supabase'), originalname: 'test.txt', mimetype: 'text/plain' }; fs.uploadFile(mockFile, 'test').then(url => console.log('URL:', url)).catch(e => console.error('에러:', e))"
```

---

## 5. 배포 정보
- 현재 백엔드는 **Railway**를 통해 자동 배포되도록 구성할 예정입니다.
- **보안 설정 (Security)**
    - **Rate Limiting**: SMS 발송 등 민감한 API는 `@nestjs/throttler`를 통해 IP당 요청 횟수가 제한되어 있습니다.
    - **CORS**: `src/main.ts`에서 설정하며, 배포 시 `origin`을 프론트엔드 도메인으로 반드시 제한해야 합니다.

- 배포 시 `.env` 파일의 변수들을 Railway 대시보드 환경변수 설정에 반드시 등록해야 합니다.
